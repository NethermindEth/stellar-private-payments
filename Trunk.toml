[build]
target = "app/index.html"
public-url = "/"
dist = "dist"
filehash = false
release = true

[watch]
watch = ["app", "circuits"]
ignore = ["app/node_modules", "dist"]

[serve]
addresses = ["0.0.0.0"]
port = 8000

[tools]
tailwindcss = "4.1.18"

# Copy all static assets to staging
[[hooks]]
stage = "pre_build"
command = "sh"
command_arguments = ["-c", """
mkdir -p dist/.stage/circuits dist/.stage/keys dist/.stage/js/witness

# Circuit artifacts from Cargo build output
CIRCUIT_OUT=$(find target -path '*/build/circuits-*/out/circuits' -type d 2>/dev/null | head -1)
if [ -n "$CIRCUIT_OUT" ]; then
    cp "$CIRCUIT_OUT"/*.r1cs dist/.stage/circuits/ 2>/dev/null || true
    cp "$CIRCUIT_OUT"/wasm/*_js/*.wasm dist/.stage/circuits/ 2>/dev/null || true
fi

# Proving keys
cp scripts/testdata/*_proving_key.bin dist/.stage/keys/ 2>/dev/null || true
cp scripts/testdata/*_vk.json dist/.stage/keys/ 2>/dev/null || true

# Witness WASM module
cp target/wasm-witness/witness.js dist/.stage/js/witness/ 2>/dev/null || true
cp target/wasm-witness/witness_bg.wasm dist/.stage/js/witness/ 2>/dev/null || true

# Static files
cp app/js/bridge.js dist/.stage/js/
cp app/test.html dist/.stage/ 2>/dev/null || true
cp scripts/deployments.json dist/.stage/ 2>/dev/null || true
"""]

# Bundle JS with esbuild
[[hooks]]
stage = "build"
command = "sh"
command_arguments = ["-c", """
./app/node_modules/.bin/esbuild app/js/ui.js --external:./prover.js --external:./witness/* --bundle --outfile=dist/.stage/js/ui.js --format=esm
./app/node_modules/.bin/esbuild app/js/worker.js --external:./prover.js --external:./witness/* --bundle --outfile=dist/.stage/js/worker.js --format=esm
"""]

# Run wasm-opt with bulk-memory support on both prover and witness
# We run it as a post-hook because we were not able to pass required flags directly to Trunk
[[hooks]]
stage = "post_build"
command = "sh"
command_arguments = ["-c", """
WASM_OPT="$HOME/.cache/trunk/wasm-opt-version_123/bin/wasm-opt"
OPT_FLAGS="--enable-bulk-memory --enable-nontrapping-float-to-int --enable-sign-ext -O3"

PROVER_WASM="dist/js/prover_bg.wasm"
if [ -x "$WASM_OPT" ] && [ -f "$PROVER_WASM" ]; then
    "$WASM_OPT" $OPT_FLAGS -o "$PROVER_WASM.opt" "$PROVER_WASM" && mv "$PROVER_WASM.opt" "$PROVER_WASM"
else
    echo "[wasm-opt] Skipped prover: wasm-opt=$WASM_OPT exists=$([ -x \"$WASM_OPT\" ] && echo yes || echo no), file exists=$([ -f \"$PROVER_WASM\" ] && echo yes || echo no)"
fi

WITNESS_WASM="dist/js/witness/witness_bg.wasm"
if [ -x "$WASM_OPT" ] && [ -f "$WITNESS_WASM" ]; then
    "$WASM_OPT" $OPT_FLAGS -o "$WITNESS_WASM.opt" "$WITNESS_WASM" && mv "$WITNESS_WASM.opt" "$WITNESS_WASM"
else
    echo "[wasm-opt] Skipped witness: file exists=$([ -f \"$WITNESS_WASM\" ] && echo yes || echo no)"
fi

"""]
