[build]
target = "app/index.html"
public-url = "/"
dist = "dist"
filehash = false

[watch]
watch = ["app", "circuits"]
ignore = ["app/node_modules"]

[serve]
addresses = ["0.0.0.0"]
port = 8000

[tools]
tailwindcss = "4.1.18"

# Build Rust src before main frontend build
[[hooks]]
stage = "pre_build"
command = "sh"
command_arguments = ["-c", "wasm-pack build app --out-name prover --no-opt --target web --no-pack --no-typescript --out-dir ../../../dist/.stage/js/prover && rm -rf dist/.stage/js/prover/.gitignore"]

# Copy witness module to staging
[[hooks]]
stage = "pre_build"
command = "sh"
command_arguments = ["-c", "mkdir -p dist/.stage/js/witness && cp app/js/witness/index.js dist/.stage/js/witness/ && cp app/js/witness/witness_calculator.js dist/.stage/js/witness/"]

# Copy circuit artifacts (Wasm and R1CS) to staging
[[hooks]]
stage = "pre_build"
command = "sh"
command_arguments = ["-c", "mkdir -p dist/.stage/circuits && for dir in circuits/src/tmp/*_js; do if [ -d \"$dir\" ]; then name=$(basename $dir _js); cp \"$dir/$name.wasm\" dist/.stage/circuits/ 2>/dev/null || true; fi; done && cp circuits/src/tmp/*.r1cs dist/.stage/circuits/ 2>/dev/null || true"]

# Copy proving keys to staging
[[hooks]]
stage = "pre_build"
command = "sh"
command_arguments = ["-c", "mkdir -p dist/.stage/keys && cp scripts/testdata/*_proving_key.bin dist/.stage/keys/ 2>/dev/null || true && cp scripts/testdata/*_vk.json dist/.stage/keys/ 2>/dev/null || true"]

# TODO: Remove once we have the main page working
# Copy test.html and bridge.js to staging
[[hooks]]
stage = "pre_build"
command = "sh"
command_arguments = ["-c", "cp app/test.html dist/.stage/test.html 2>/dev/null || true && mkdir -p dist/.stage/js && cp app/js/bridge.js dist/.stage/js/bridge.js"]

# Bundle ui.js
[[hooks]]
stage = "build"
command = "sh"
command_arguments = ["-c", "./app/node_modules/.bin/esbuild app/js/ui.js --bundle --outfile=dist/.stage/js/ui.js --format=esm"]

# Bundle worker.js - uses external imports for prover/witness (resolved at runtime)
[[hooks]]
stage = "build"
command = "sh"
command_arguments = ["-c", "./app/node_modules/.bin/esbuild app/js/worker.js --external:./app.js --external:./prover/* --external:./witness/* --bundle --outfile=dist/.stage/js/worker.js --format=esm"]