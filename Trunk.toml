[build]
target = "app/index.html"
public-url = "/"
dist = "dist"
filehash = false
release = true

[watch]
watch = ["app", "circuits"]
ignore = ["app/node_modules", "dist"]

[serve]
addresses = ["0.0.0.0"]
port = 8000

[tools]
tailwindcss = "4.1.18"

# Copy all static assets to staging
[[hooks]]
stage = "pre_build"
command = "sh"
command_arguments = ["-c", """
mkdir -p dist/.stage/circuits dist/.stage/keys dist/.stage/js/witness dist/.stage/vendor

# Circuit artifacts from Cargo build output
CIRCUIT_OUT=$(find target -path '*/build/circuits-*/out/circuits' -type d 2>/dev/null | head -1)
if [ -n "$CIRCUIT_OUT" ]; then
    cp "$CIRCUIT_OUT"/*.r1cs dist/.stage/circuits/ 2>/dev/null || true
    cp "$CIRCUIT_OUT"/wasm/*_js/*.wasm dist/.stage/circuits/ 2>/dev/null || true
fi

# Proving keys
cp scripts/testdata/*_proving_key.bin dist/.stage/keys/ 2>/dev/null || true
cp scripts/testdata/*_vk.json dist/.stage/keys/ 2>/dev/null || true

# Witness WASM module
cp target/wasm-witness/witness.js dist/.stage/js/witness/ 2>/dev/null || true
cp target/wasm-witness/witness_bg.wasm dist/.stage/js/witness/ 2>/dev/null || true

# Static files
cp app/js/bridge.js dist/.stage/js/
cp app/test.html dist/.stage/ 2>/dev/null || true
cp app/zkProofTest.html dist/.stage/ 2>/dev/null || true
cp target/stellar/pool.wasm dist/.stage/pool.wasm 2>/dev/null || true
cp scripts/deployments.json dist/.stage/ 2>/dev/null || true
cp app/node_modules/@stellar/freighter-api/build/index.min.js dist/.stage/vendor/freighter-api.min.js 2>/dev/null || true
cp app/node_modules/@stellar/stellar-sdk/dist/stellar-sdk.min.js dist/.stage/vendor/stellar-sdk.min.js 2>/dev/null || true
"""]

# Bundle JS with esbuild
[[hooks]]
stage = "build"
command = "sh"
command_arguments = ["-c", """
./app/node_modules/.bin/esbuild app/js/ui.js --external:./prover.js --external:./witness/* --bundle --outfile=dist/.stage/js/ui.js --format=esm
./app/node_modules/.bin/esbuild app/js/worker.js --external:./prover.js --external:./witness/* --bundle --outfile=dist/.stage/js/worker.js --format=esm
"""]
