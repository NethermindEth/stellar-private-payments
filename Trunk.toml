[build]
target = "app/index.html"
public-url = "/"
dist = "dist"
filehash = false
release = true

[watch]
watch = ["app", "circuits"]
ignore = ["app/node_modules", "dist"]

[serve]
addresses = ["0.0.0.0"]
port = 8000

[tools]
tailwindcss = "4.1.18"

# Copy circuit artifacts, proving keys, witness module, and static JS
[[hooks]]
stage = "pre_build"
command = "sh"
command_arguments = ["-c", """
mkdir -p dist/.stage/circuits dist/.stage/keys dist/.stage/js/witness

# Circuit artifacts from build output
CIRCUIT_OUT=$(find target -path '*/build/circuits-*/out/circuits' -type d 2>/dev/null | head -1)
if [ -n "$CIRCUIT_OUT" ]; then
    cp "$CIRCUIT_OUT"/*.r1cs dist/.stage/circuits/ 2>/dev/null || true
    cp "$CIRCUIT_OUT"/wasm/*_js/*.wasm dist/.stage/circuits/ 2>/dev/null || true
fi

# Proving keys and verification keys
cp scripts/testdata/*_proving_key.bin dist/.stage/keys/ 2>/dev/null || true
cp scripts/testdata/*_vk.json dist/.stage/keys/ 2>/dev/null || true

# Witness WASM module (built by wasm-pack)
if [ -d "target/wasm-witness" ]; then
    cp target/wasm-witness/witness.js dist/.stage/js/witness/ 2>/dev/null || true
    cp target/wasm-witness/witness_bg.wasm dist/.stage/js/witness/ 2>/dev/null || true
fi

# Static files (bridge.js is external to esbuild bundles, test.html for dev)
cp app/js/bridge.js dist/.stage/js/
cp app/test.html dist/.stage/ 2>/dev/null || true
"""]

# Bundle JS files with npm dependencies
[[hooks]]
stage = "build"
command = "sh"
command_arguments = ["-c", """
cd app && ./node_modules/.bin/esbuild \
    js/worker.js \
    js/wallet.js \
    js/stellar.js \
    --bundle \
    --format=esm \
    --outdir=../dist/.stage/js \
    --external:./prover.js \
    --external:./witness/* \
    --external:./bridge.js
"""]
