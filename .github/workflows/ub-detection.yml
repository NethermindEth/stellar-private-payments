name: UB (undefined behavior) detection

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  # Make sure CI fails on all warnings, including Clippy lints
  RUSTFLAGS: "-Dwarnings"

jobs:
  ub-detection:
    name: Check for undefined behaviour (UB)
    timeout-minutes: 480
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          rustup +nightly component add miri
          cargo +nightly miri setup
          # Strict provenance for all crates except circom-groth16-verifier
          MIRIFLAGS="-Zmiri-strict-provenance" cargo +nightly miri test --lib --workspace --exclude circom-groth16-verifier
          # circom-groth16-verifier uses ark-groth16 → rayon → crossbeam-epoch,
          # which does integer-to-pointer casts incompatible with strict provenance.
          MIRIFLAGS="-Zmiri-permissive-provenance" cargo +nightly miri test --lib -p circom-groth16-verifier
